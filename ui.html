<!doctype html>
<html data-theme="light">
<head>
<meta charset="utf-8" />
<style>
/* â”€â”€ Theme tokens â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
[data-theme="light"] {
  --bg:     #fff;
  --panel:  #f5f5f5;
  --text:   #1e1e1e;
  --muted:  #888;
  --border: #ddd;
  --shadow: rgba(0,0,0,.08);
  --accent: #0d99ff;
  --accent-text: #fff;
  --danger: #e03e3e;
  --tab-bg: #eee;
  --tab-active-bg: #fff;
  --input-bg: #fff;
  --toast-bg: #1e1e1e;
  --toast-text: #fff;
}
[data-theme="dark"] {
  --bg:     #2c2c2c;
  --panel:  #383838;
  --text:   #e0e0e0;
  --muted:  #888;
  --border: #444;
  --shadow: rgba(0,0,0,.3);
  --accent: #0d99ff;
  --accent-text: #fff;
  --danger: #ff6b6b;
  --tab-bg: #383838;
  --tab-active-bg: #2c2c2c;
  --input-bg: #333;
  --toast-bg: #e0e0e0;
  --toast-text: #1e1e1e;
}

/* â”€â”€ Figma CSS var overrides (primary source) â”€â”€ */
html, body {
  margin: 0; padding: 0;
  font-family: Inter, system-ui, -apple-system, sans-serif;
  font-size: 12px;
  background: var(--figma-color-bg, var(--bg));
  color: var(--figma-color-text, var(--text));
  overflow: hidden;
  height: 100%;
  min-height: 0;
}
html { height: 100%; }
body { height: 100%; display: flex; flex-direction: column; }

/* â”€â”€ Shared â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
* { box-sizing: border-box; }

button {
  font-family: inherit; font-size: 12px;
  cursor: pointer; border: none; border-radius: 6px;
  padding: 6px 14px;
  background: var(--figma-color-bg-secondary, var(--panel));
  color: var(--figma-color-text, var(--text));
  border: 1px solid var(--figma-color-border, var(--border));
}
button:hover { opacity: .85; }
button.primary {
  background: var(--accent);
  color: var(--accent-text);
  border-color: var(--accent);
}

input, textarea {
  font-family: inherit; font-size: 12px;
  background: var(--figma-color-bg, var(--input-bg));
  color: var(--figma-color-text, var(--text));
  border: 1px solid var(--figma-color-border, var(--border));
  border-radius: 6px;
  padding: 6px 8px;
  outline: none;
  width: 100%;
}
input:focus, textarea:focus {
  border-color: var(--accent);
}
textarea {
  resize: vertical;
  min-height: 80px;
  max-height: 400px;
}

/* â”€â”€ Rich text editor â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.rt-wrap {
  border: 1px solid var(--figma-color-border, var(--border));
  border-radius: 6px;
  overflow: hidden;
  transition: border-color .15s;
}
.rt-wrap:focus-within {
  border-color: var(--accent);
}
.rt-toolbar {
  display: flex; align-items: center; gap: 1px;
  padding: 4px 6px;
  background: var(--figma-color-bg-secondary, var(--panel));
  border-bottom: 1px solid var(--figma-color-border, var(--border));
}
.rt-toolbar .rt-sep {
  width: 1px; height: 16px; margin: 0 4px;
  background: var(--figma-color-border, var(--border));
}
.rt-btn {
  width: 26px; height: 24px;
  display: flex; align-items: center; justify-content: center;
  padding: 0; font-size: 12px;
  background: none; border: none;
  border-radius: 4px; cursor: pointer;
  color: var(--figma-color-text-secondary, var(--muted));
}
.rt-btn:hover {
  background: var(--figma-color-bg, var(--bg));
  color: var(--figma-color-text, var(--text));
}
.rt-btn.active {
  background: var(--accent);
  color: var(--accent-text);
}
.rt-editor {
  font-family: inherit; font-size: 12px;
  background: var(--figma-color-bg, var(--input-bg));
  color: var(--figma-color-text, var(--text));
  border: none;
  padding: 8px;
  outline: none;
  min-height: 80px;
  max-height: 400px;
  overflow-y: auto;
  white-space: pre-wrap; word-break: break-word;
}
.rt-editor:empty::before {
  content: attr(data-placeholder);
  color: var(--figma-color-text-secondary, var(--muted));
  pointer-events: none;
}
.rt-editor a {
  color: var(--accent); text-decoration: underline;
}
/* Inline link input bar */
.rt-link-bar {
  display: none; align-items: center; gap: 6px;
  padding: 6px 8px;
  background: var(--figma-color-bg-secondary, var(--panel));
  border-top: 1px solid var(--figma-color-border, var(--border));
}
.rt-link-bar.visible { display: flex; }
.rt-link-bar input {
  flex: 1; font-size: 11px; padding: 4px 6px;
  border-radius: 4px; min-width: 0;
}
.rt-link-bar button {
  font-size: 11px; padding: 4px 8px;
  border-radius: 4px;
}

/* Rich text in preview + drift */
.pv-body a {
  color: var(--accent); text-decoration: underline;
}

/* â”€â”€ Screen container â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.screen { display: none; flex: 1; min-height: 0; }
.screen.active { display: flex; flex-direction: column; }

/* â”€â”€ 1. Chip â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#screen-chip {
  flex-direction: row;
  align-items: center;
  justify-content: space-between;
  padding: 0 10px;
  height: 32px;
}
#screen-chip .label { font-size: 12px; font-weight: 500; }
#screen-chip .gear {
  width: 22px; height: 22px;
  display: flex; align-items: center; justify-content: center;
  border: 1px solid var(--figma-color-border, var(--border));
  border-radius: 7px;
  cursor: pointer; user-select: none; font-size: 13px;
}
#screen-chip .gear:hover { opacity: .7; }

/* â”€â”€ 2. Authoring â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#screen-authoring {
  height: 100%;
}

/* Top-level nav (Guidance / Index) â€” primary tabs */
.top-nav {
  display: flex; gap: 0; padding: 0 14px;
  background: var(--figma-color-bg-secondary, var(--panel));
  border-bottom: 1px solid var(--figma-color-border, var(--border));
}
.top-tab {
  padding: 10px 16px 8px; cursor: pointer; font-size: 13px; font-weight: 600;
  color: var(--figma-color-text-secondary, var(--muted));
  border: none; border-bottom: 2px solid transparent;
  background: none; border-radius: 0;
  letter-spacing: .01em;
}
.top-tab:hover { color: var(--figma-color-text, var(--text)); }
.top-tab.active {
  color: var(--figma-color-text, var(--text));
  border-bottom-color: var(--accent);
}

/* Category tabs (Component / Text / Color / Typography) â€” secondary pills */
.tabs {
  display: flex; gap: 6px; padding: 8px 14px;
}
.tab {
  padding: 4px 10px; cursor: pointer;
  font-size: 11px; font-weight: 500;
  color: var(--figma-color-text-secondary, var(--muted));
  border: 1px solid transparent;
  border-radius: 100px;
  position: relative; user-select: none;
  background: none;
}
.tab:hover {
  color: var(--figma-color-text, var(--text));
  background: var(--figma-color-bg-secondary, var(--panel));
}
.tab.active {
  color: var(--figma-color-text, var(--text));
  background: var(--figma-color-bg-secondary, var(--panel));
  border-color: var(--figma-color-border, var(--border));
}
.tab .dirty-dot {
  display: none;
  width: 5px; height: 5px;
  background: var(--accent);
  border-radius: 50%;
  position: absolute; top: 2px; right: 2px;
}
.tab.dirty .dirty-dot { display: block; }

.authoring-body {
  display: flex; flex: 1; min-height: 0; overflow: hidden;
}

/* editor pane */
.editor-pane {
  flex: 1; padding: 14px; overflow-y: auto;
  display: flex; flex-direction: column; gap: 10px;
  border-right: 1px solid var(--figma-color-border, var(--border));
}
.editor-pane .field { display: flex; flex-direction: column; gap: 3px; }
.editor-pane .field label {
  font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: .5px;
  color: var(--figma-color-text-secondary, var(--muted));
}
.editor-pane .cta-row { display: flex; gap: 8px; flex-wrap: wrap; }
.editor-pane .cta-row .field { flex: 1 1 120px; min-width: 0; }
.editor-pane .save-row {
  display: flex; align-items: center; gap: 10px; margin-top: 4px;
}
.editor-pane .saved-msg {
  font-size: 11px; color: var(--accent); opacity: 0;
  transition: opacity .3s;
}
.editor-pane .saved-msg.show { opacity: 1; }

/* preview pane */
.preview-pane {
  flex: 1; min-width: 0;
  padding: 14px; overflow-y: auto;
  display: flex; flex-direction: column; gap: 8px;
}
.preview-pane .preview-label {
  font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: .5px;
  color: var(--figma-color-text-secondary, var(--muted));
}
.preview-card {
  border: 1px solid var(--figma-color-border, var(--border));
  border-radius: 8px; padding: 12px;
  display: flex; flex-direction: column; gap: 8px;
  background: var(--figma-color-bg, var(--bg));
}
.preview-card .pv-headline {
  font-size: 13px; font-weight: 600;
  color: var(--figma-color-text, var(--text));
  min-height: 16px;
}
.preview-card .pv-body {
  font-size: 11px; line-height: 1.4;
  color: var(--figma-color-text-secondary, var(--muted));
  min-height: 20px;
  white-space: pre-wrap; word-break: break-word;
}
.preview-card .pv-ctas {
  display: flex; gap: 6px; margin-top: 4px;
}
.preview-card .pv-ctas button {
  font-size: 11px; padding: 4px 10px;
}

/* â”€â”€ 3. Index screens â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#screen-index-start,
#screen-index-results {
  height: 100%;
}

.index-body {
  padding: 20px 16px;
  display: flex; flex-direction: column; gap: 12px;
  flex: 1; min-height: 0;
}
.index-body h3 { margin: 0; font-size: 14px; font-weight: 600; }
.index-body p {
  margin: 0; font-size: 12px; line-height: 1.5;
  color: var(--figma-color-text-secondary, var(--muted));
}
.index-count {
  font-weight: 500;
  color: var(--figma-color-text, var(--text));
}
.index-list {
  flex: 1; min-height: 0; max-height: 200px;
  overflow-y: auto;
  display: flex; flex-direction: column; gap: 4px;
}
.index-item {
  display: flex; align-items: center; gap: 8px;
  padding: 6px 8px;
  background: var(--figma-color-bg-secondary, var(--panel));
  border-radius: 6px; font-size: 12px;
}
.index-item .checkmark {
  color: var(--accent); font-size: 14px; flex-shrink: 0;
}
.index-actions {
  display: flex; justify-content: flex-end; gap: 8px;
  margin-top: 12px;
}

/* â”€â”€ 4. Drift modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#screen-drift {
  padding: 16px;
  gap: 12px;
}
#screen-drift .drift-card {
  border: none;
}
#screen-drift .pv-ctas {
  margin-top: 16px;
}
#screen-drift .pv-ctas button:empty {
  display: none;
}
.preview-card .pv-ctas button:empty {
  display: none;
}

/* â”€â”€ Resize handle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.resize-handle {
  position: fixed; bottom: 0; right: 0;
  width: 16px; height: 16px;
  cursor: nwse-resize;
  display: none;          /* shown only on resizable screens */
  z-index: 200;
  opacity: 0.4;
  transition: opacity .15s;
}
.resize-handle:hover { opacity: 0.8; }
.resize-handle svg { display: block; width: 100%; height: 100%; }
body.resizable .resize-handle { display: block; }

/* â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toast {
  position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%);
  background: var(--toast-bg); color: var(--toast-text);
  padding: 6px 14px; border-radius: 6px; font-size: 11px;
  opacity: 0; transition: opacity .3s; pointer-events: none;
  z-index: 100;
}
.toast.show { opacity: 1; }
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â• SCREEN: Chip â•â•â•â•â•â•â•â• -->
<div id="screen-chip" class="screen active">
  <div class="label">Detach <span id="detach-count">0</span></div>
  <div class="gear" id="btn-gear" title="Setup">âš™</div>
</div>

<!-- â•â•â•â•â•â•â•â• SCREEN: Drift modal â•â•â•â•â•â•â•â• -->
<div id="screen-drift" class="screen">
  <div class="preview-card drift-card">
    <div class="pv-headline" id="drift-headline"></div>
    <div class="pv-body" id="drift-body"></div>
    <div class="pv-ctas">
      <button class="primary" id="drift-cta1"></button>
      <button id="drift-cta2"></button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â• SCREEN: Authoring â•â•â•â•â•â•â•â• -->
<div id="screen-authoring" class="screen">
  <div class="top-nav">
    <button class="top-tab active" data-section="guidance">Guidance</button>
    <button class="top-tab" data-section="index">Index</button>
  </div>
  <div class="tabs" id="tab-bar">
    <button class="tab active" data-cat="component">Component<span class="dirty-dot"></span></button>
    <button class="tab" data-cat="text">Text<span class="dirty-dot"></span></button>
    <button class="tab" data-cat="color">Color<span class="dirty-dot"></span></button>
    <button class="tab" data-cat="typography">Typography<span class="dirty-dot"></span></button>
  </div>
  <div class="authoring-body">
    <div class="editor-pane">
      <div class="field">
        <label>Headline</label>
        <input type="text" id="ed-headline" placeholder="e.g. Component detached" />
      </div>
      <div class="field">
        <label>Description</label>
        <div class="rt-wrap">
          <div class="rt-toolbar">
            <button type="button" class="rt-btn" data-cmd="bold" title="Bold"><b>B</b></button>
            <button type="button" class="rt-btn" data-cmd="italic" title="Italic"><i>I</i></button>
            <span class="rt-sep"></span>
            <button type="button" class="rt-btn" data-cmd="link" title="Insert link">ðŸ”—</button>
          </div>
          <div class="rt-editor" id="ed-description" contenteditable="true"
               data-placeholder="Explain what happened and what to do insteadâ€¦"></div>
          <div class="rt-link-bar" id="rt-link-bar">
            <input type="text" id="rt-link-url" placeholder="https://â€¦" />
            <button class="primary" id="rt-link-apply">Apply</button>
            <button id="rt-link-cancel">Cancel</button>
          </div>
        </div>
      </div>
      <div class="cta-row">
        <div class="field">
          <label>CTA 1 label</label>
          <input type="text" id="ed-cta1" placeholder="e.g. Undo" />
        </div>
        <div class="field">
          <label>CTA 2 label</label>
          <input type="text" id="ed-cta2" placeholder="e.g. Open docs" />
        </div>
      </div>
      <div class="save-row">
        <button class="primary" id="btn-save">Save</button>
        <button id="btn-close-editor">Close</button>
        <span class="saved-msg" id="saved-msg">Saved âœ“</span>
      </div>
    </div>
    <div class="preview-pane">
      <div class="preview-label">Preview</div>
      <div class="preview-card">
        <div class="pv-headline" id="pv-headline"></div>
        <div class="pv-body" id="pv-body"></div>
        <div class="pv-ctas">
          <button class="primary" id="pv-cta1"></button>
          <button id="pv-cta2"></button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â• SCREEN: Index Start â•â•â•â•â•â•â•â• -->
<div id="screen-index-start" class="screen">
  <div class="top-nav">
    <button class="top-tab" data-section="guidance">Guidance</button>
    <button class="top-tab active" data-section="index">Index</button>
  </div>
  <div class="index-body">
    <h3>Index this file's components</h3>
    <p>Coach will scan local components and component sets so it can recognize detaches more reliably.</p>
    <div class="index-actions">
      <button id="btn-index-cancel">Cancel</button>
      <button class="primary" id="btn-index-run">Index components</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â• SCREEN: Index Results â•â•â•â•â•â•â•â• -->
<div id="screen-index-results" class="screen">
  <div class="top-nav">
    <button class="top-tab" data-section="guidance">Guidance</button>
    <button class="top-tab active" data-section="index">Index</button>
  </div>
  <div class="index-body">
    <p class="index-count"><span id="indexed-count">0</span> components found</p>
    <div class="index-list" id="index-list"></div>
    <div class="index-actions">
      <button class="primary" id="btn-index-done">Done</button>
    </div>
  </div>
</div>

<!-- Resize handle (bottom-right corner) -->
<div class="resize-handle" id="resize-handle">
  <svg viewBox="0 0 16 16" fill="none">
    <path d="M5 15L15 5"  stroke="currentColor" stroke-width="1.2" stroke-linecap="round"/>
    <path d="M9 15L15 9"  stroke="currentColor" stroke-width="1.2" stroke-linecap="round"/>
    <path d="M13 15L15 13" stroke="currentColor" stroke-width="1.2" stroke-linecap="round"/>
  </svg>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Coach Â· UI logic â€” state machine
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

/* â”€â”€ View states â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const VIEW = {
  TINY_CHIP:        'chip',
  DRIFT_MODAL:      'drift',
  AUTHORING:        'authoring',
  INDEX_START:      'index-start',
  INDEX_RESULTS:    'index-results',
};

/* â”€â”€ Sizes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const CHIP_W = 170, CHIP_H = 32;
const AUTH_MIN_W = 700, AUTH_MIN_H = 420;
const INDEX_W = 460, INDEX_H = 320;

const DRIFT_W = 480, DRIFT_MAX_H = 400, DRIFT_PAD = 12;
const DEFAULT_CONTENT = {
  component: {
    headline: 'Component detached',
    description: 'Try the component properties\u2014there\u2019s likely a variant for this. Detached components won\u2019t receive updates and can drift from approved patterns. If this detach was accidental, undo it and pick the right variant instead.',
    cta1: 'Got it',
    cta2: ''
  },
  text: {
    headline: 'Text style removed',
    description: 'Try the text styles panel\u2014there\u2019s probably an approved style that matches what you\u2019re after. Unstyled text can drift from the system and won\u2019t benefit from future updates. If this was accidental, undo and re-apply the right text style.',
    cta1: 'Got it',
    cta2: ''
  },
  color: {
    headline: 'Color token unbound',
    description: 'Try the color styles/variables\u2014there\u2019s likely an approved token for this. Raw colors won\u2019t receive updates and can drift from the system. If this was accidental, undo and re-apply the correct token.',
    cta1: 'Got it',
    cta2: ''
  },
  typography: {
    headline: 'Typography token unbound',
    description: 'Try the type styles/variables\u2014there\u2019s likely an approved token that fits. Manual typography won\u2019t receive updates and can drift from approved patterns. If this was accidental, undo and re-apply the correct token.',
    cta1: 'Got it',
    cta2: ''
  }
};

const CATEGORIES = ['component', 'text', 'color', 'typography'];
const CAT_LABELS = { component: 'Component', text: 'Text', color: 'Color', typography: 'Typography' };

/* â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let currentView = VIEW.TINY_CHIP;
let content = null;
let currentCat = 'component';
let savedSnapshot = null;
let userName = '';        // current Figma user's display name, sent by code.js
let userId = '';          // current Figma user's ID, sent by code.js
let indexedComponents = [];             // last indexed component list

function defaultContent() {
  const out = {};
  CATEGORIES.forEach(c => {
    var d = DEFAULT_CONTENT[c] || {};
    out[c] = { headline: d.headline || '', description: d.description || '', cta1: d.cta1 || '', cta2: d.cta2 || '' };
  });
  return out;
}

/* â”€â”€ Theme â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function detectThemeFromFigmaVars() {
  const bg = getComputedStyle(document.documentElement).getPropertyValue('--figma-color-bg').trim();
  if (!bg) return 'light';
  const m = bg.match(/\d+/g);
  if (m && m.length >= 3) {
    const lum = (0.299 * +m[0] + 0.587 * +m[1] + 0.114 * +m[2]) / 255;
    return lum < 0.5 ? 'dark' : 'light';
  }
  return 'light';
}

function applyTheme() {
  document.documentElement.dataset.theme = detectThemeFromFigmaVars();
}
applyTheme();
setInterval(applyTheme, 2000);

/* â”€â”€ Figma comms â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
window.onmessage = (event) => {
  const msg = event.data.pluginMessage;
  if (!msg) return;
  handleMessage(msg);
};

function post(msg) {
  parent.postMessage({ pluginMessage: msg }, '*');
}

function resize(w, h) {
  post({ type: 'resize', width: w, height: h });
}

/* â”€â”€ HTML sanitizer (rich text output) â”€â”€â”€â”€â”€â”€â”€â”€ */
function sanitizeHTML(html) {
  var tmp = document.createElement('div');
  tmp.innerHTML = html;
  var allowed = ['B','I','EM','STRONG','A','BR','P','UL','OL','LI'];
  function walk(parent) {
    Array.from(parent.childNodes).forEach(function(node) {
      if (node.nodeType === 3) return;
      if (node.nodeType === 1) {
        if (allowed.indexOf(node.tagName) < 0) {
          parent.replaceChild(document.createTextNode(node.textContent), node);
        } else {
          Array.from(node.attributes).forEach(function(attr) {
            if (!(node.tagName === 'A' && attr.name === 'href')) {
              node.removeAttribute(attr.name);
            }
          });
          if (node.tagName === 'A') {
            var href = (node.getAttribute('href') || '').trim().toLowerCase();
            if (href && !href.startsWith('http://') && !href.startsWith('https://')) {
              // Strip unsafe protocols (javascript:, data:, etc.)
              node.removeAttribute('href');
            }
            node.setAttribute('target', '_blank');
            node.setAttribute('rel', 'noopener');
          }
          walk(node);
        }
      }
    });
  }
  walk(tmp);
  return tmp.innerHTML;
}

/* â”€â”€ Height measurement for drift modal â”€â”€â”€â”€â”€â”€â”€â”€ */
function measureDriftHeight() {
  // Create an off-screen container at DRIFT_W so the card lays out
  // at the correct width regardless of the iframe's current size.
  var probe = document.createElement('div');
  probe.style.cssText =
    'position:absolute;left:-9999px;top:0;' +
    'width:' + DRIFT_W + 'px;padding:16px;' +
    'display:flex;flex-direction:column;gap:12px;';
  var card = document.querySelector('#screen-drift .drift-card');
  var clone = card.cloneNode(true);
  probe.appendChild(clone);
  document.body.appendChild(probe);
  var h = probe.offsetHeight;
  document.body.removeChild(probe);
  return h;
}

/* â”€â”€ Screen navigation (state machine) â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function showScreen(id) {
  const previousView = currentView;
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  const screen = document.getElementById('screen-' + id);
  screen.classList.add('active');
  currentView = id;

  // Toggle resize handle: on Authoring & Index screens
  const resizable = (id === VIEW.AUTHORING || id === VIEW.INDEX_START || id === VIEW.INDEX_RESULTS);
  document.body.classList.toggle('resizable', resizable);

  switch (id) {
    case VIEW.TINY_CHIP:
      resize(CHIP_W, CHIP_H);
      break;

    case VIEW.DRIFT_MODAL: {
      // Measure via off-screen clone (independent of iframe size).
      const h = Math.min(measureDriftHeight() + DRIFT_PAD, DRIFT_MAX_H);
      // Ask code.js to resize + center on viewport.
      // Falls back to resize-in-place if reposition fails.
      post({ type: 'resize-center', width: DRIFT_W, height: h });
      break;
    }

    case VIEW.AUTHORING:
      // Only fetch fresh overrides when entering from outside the editing flow
      // (chip or drift). When returning from index screens, keep in-memory edits.
      if (previousView === VIEW.TINY_CHIP || previousView === VIEW.DRIFT_MODAL || !content) {
        post({ type: 'get-guidance-overrides' });
      }
      loadTabContent();
      updatePreview();
      updateDirtyDots();
      resize(AUTH_MIN_W, AUTH_MIN_H);
      break;

    case VIEW.INDEX_START:
      resize(INDEX_W, INDEX_H);
      break;

    case VIEW.INDEX_RESULTS:
      renderIndexedComponents();
      resize(INDEX_W, INDEX_H);
      break;
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCREEN 1 : Tiny chip
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

document.getElementById('btn-gear').onclick = () => {
  showScreen(VIEW.AUTHORING);
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCREEN 1b : Drift modal
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

document.getElementById('drift-cta1').onclick = () => showScreen(VIEW.TINY_CHIP);
document.getElementById('drift-cta2').onclick = () => showScreen(VIEW.TINY_CHIP);

function showDriftModal(category, catContent) {
  var defaults = DEFAULT_CONTENT[category] || DEFAULT_CONTENT.component;
  var c = catContent || defaults;
  document.getElementById('drift-headline').textContent = c.headline || defaults.headline;
  document.getElementById('drift-body').innerHTML = sanitizeHTML(c.description || defaults.description);
  document.getElementById('drift-cta1').textContent = c.cta1 || defaults.cta1;
  document.getElementById('drift-cta2').textContent = c.cta2 || '';
  showScreen(VIEW.DRIFT_MODAL);
}

function updateChipCount(n) {
  document.getElementById('detach-count').textContent = n;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCREEN 2 : Authoring (Guidance editor)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll('.tab').forEach(tab => {
  tab.onclick = () => {
    readEditorIntoContent(); // save current tab edits in memory
    currentCat = tab.dataset.cat;
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    loadTabContent();
    updatePreview();
  };
});

function loadTabContent() {
  if (!content) content = defaultContent();
  const cat = content[currentCat] || { headline: '', description: '', cta1: '', cta2: '' };
  document.getElementById('ed-headline').value = cat.headline || '';
  document.getElementById('ed-description').innerHTML = cat.description || '';
  document.getElementById('ed-cta1').value = cat.cta1 || '';
  document.getElementById('ed-cta2').value = cat.cta2 || '';
}

function readEditorIntoContent() {
  if (!content) content = defaultContent();
  content[currentCat] = {
    headline: document.getElementById('ed-headline').value,
    description: document.getElementById('ed-description').innerHTML,
    cta1: document.getElementById('ed-cta1').value,
    cta2: document.getElementById('ed-cta2').value,
  };
}

// â”€â”€ Live preview â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updatePreview() {
  if (!content) content = defaultContent();
  const cat = content[currentCat] || {};
  document.getElementById('pv-headline').textContent = cat.headline || '';
  document.getElementById('pv-body').innerHTML = sanitizeHTML(cat.description || '');
  document.getElementById('pv-cta1').textContent = cat.cta1 || '';
  document.getElementById('pv-cta2').textContent = cat.cta2 || '';
}

['ed-headline', 'ed-cta1', 'ed-cta2'].forEach(id => {
  document.getElementById(id).addEventListener('input', () => {
    readEditorIntoContent();
    updatePreview();
    updateDirtyDots();
  });
});

// contenteditable description fires input events too
document.getElementById('ed-description').addEventListener('input', () => {
  readEditorIntoContent();
  updatePreview();
  updateDirtyDots();
});

// â”€â”€ Rich text toolbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var savedLinkRange = null;  // saved selection range for link insertion

function updateToolbarState() {
  document.querySelectorAll('.rt-btn').forEach(btn => {
    const cmd = btn.dataset.cmd;
    if (cmd === 'bold') {
      btn.classList.toggle('active', document.queryCommandState('bold'));
    } else if (cmd === 'italic') {
      btn.classList.toggle('active', document.queryCommandState('italic'));
    }
  });
}

document.getElementById('ed-description').addEventListener('keyup', updateToolbarState);
document.getElementById('ed-description').addEventListener('mouseup', updateToolbarState);

document.querySelectorAll('.rt-btn').forEach(btn => {
  btn.onmousedown = (e) => e.preventDefault(); // keep focus in editor
  btn.onclick = () => {
    var cmd = btn.dataset.cmd;
    if (cmd === 'bold') {
      document.execCommand('bold', false, null);
    } else if (cmd === 'italic') {
      document.execCommand('italic', false, null);
    } else if (cmd === 'link') {
      var sel = window.getSelection();
      if (!sel.rangeCount || sel.isCollapsed) return;
      // Save range so we can restore it after the URL input
      savedLinkRange = sel.getRangeAt(0).cloneRange();
      document.getElementById('rt-link-url').value = '';
      document.getElementById('rt-link-bar').classList.add('visible');
      document.getElementById('rt-link-url').focus();
      return; // don't update content yet
    }
    updateToolbarState();
    readEditorIntoContent();
    updatePreview();
    updateDirtyDots();
  };
});

// â”€â”€ Inline link bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('rt-link-apply').onclick = () => {
  var url = document.getElementById('rt-link-url').value.trim();
  if (url && savedLinkRange) {
    var sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(savedLinkRange);
    document.execCommand('createLink', false, url);
  }
  savedLinkRange = null;
  document.getElementById('rt-link-bar').classList.remove('visible');
  document.getElementById('ed-description').focus();
  readEditorIntoContent();
  updatePreview();
  updateDirtyDots();
};

document.getElementById('rt-link-cancel').onclick = () => {
  savedLinkRange = null;
  document.getElementById('rt-link-bar').classList.remove('visible');
  document.getElementById('ed-description').focus();
};

// Allow Enter key to apply link
document.getElementById('rt-link-url').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    document.getElementById('rt-link-apply').click();
  } else if (e.key === 'Escape') {
    e.preventDefault();
    document.getElementById('rt-link-cancel').click();
  }
});

// â”€â”€ Dirty dots â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateDirtyDots() {
  if (!savedSnapshot) savedSnapshot = JSON.stringify(defaultContent());
  const snap = JSON.parse(savedSnapshot);
  document.querySelectorAll('.tab').forEach(tab => {
    const cat = tab.dataset.cat;
    const current = content ? content[cat] : defaultContent()[cat];
    const saved = snap[cat] || defaultContent()[cat];
    const dirty = JSON.stringify(current) !== JSON.stringify(saved);
    tab.classList.toggle('dirty', dirty);
  });
}

// â”€â”€ Save â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('btn-save').onclick = () => {
  readEditorIntoContent();
  post({ type: 'save-guidance-overrides', data: content });
};

document.getElementById('btn-close-editor').onclick = () => {
  showScreen(VIEW.TINY_CHIP);
};

function showSavedMsg() {
  const el = document.getElementById('saved-msg');
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 2000);
}

// â”€â”€ Top-level nav (Guidance / Index) â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll('.top-tab').forEach(tab => {
  tab.onclick = () => {
    const section = tab.dataset.section;
    if (section === 'guidance') {
      if (currentView !== VIEW.AUTHORING) showScreen(VIEW.AUTHORING);
    } else if (section === 'index') {
      // Already on an index screen â€” nothing to do
      if (currentView === VIEW.INDEX_START || currentView === VIEW.INDEX_RESULTS) return;
      // Preserve unsaved edits in memory before leaving authoring
      if (currentView === VIEW.AUTHORING) readEditorIntoContent();
      // Ask code.js for previously indexed components, then decide which screen
      post({ type: 'get-indexed-components' });
      // Response handled in handleMessage â†’ 'indexed-components'
    }
  };
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCREEN 3 : Index
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

document.getElementById('btn-index-cancel').onclick = () => {
  showScreen(VIEW.AUTHORING);
};

document.getElementById('btn-index-run').onclick = () => {
  post({ type: 'run-indexing' });
};

document.getElementById('btn-index-done').onclick = () => {
  showScreen(VIEW.TINY_CHIP);
};

function renderIndexedComponents() {
  const list = document.getElementById('index-list');
  const countEl = document.getElementById('indexed-count');
  list.innerHTML = '';
  countEl.textContent = indexedComponents.length;
  indexedComponents.forEach(comp => {
    const item = document.createElement('div');
    item.className = 'index-item';
    const check = document.createElement('span');
    check.className = 'checkmark';
    check.textContent = '\u2713';
    item.appendChild(check);
    const name = document.createElement('span');
    name.textContent = comp.name;
    item.appendChild(name);
    list.appendChild(item);
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Messages from code.js
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

function handleMessage(msg) {
  switch (msg.type) {
    case 'theme':
      if (msg.theme) document.documentElement.dataset.theme = msg.theme;
      break;

    case 'user-identity':
      userName = msg.name || '';
      userId = msg.id || '';
      break;

    case 'guidance-overrides': {
      // Merge saved data with built-in defaults so empty fields show defaults
      var defaults = defaultContent();
      var saved = msg.data || {};
      content = {};
      CATEGORIES.forEach(function(cat) {
        var s = saved[cat] || {};
        var d = defaults[cat] || {};
        content[cat] = {
          headline:    s.headline    || d.headline    || '',
          description: s.description || d.description || '',
          cta1:        s.cta1        || d.cta1        || '',
          cta2:        s.cta2        || d.cta2        || '',
        };
      });
      savedSnapshot = JSON.stringify(content);
      if (currentView === VIEW.AUTHORING) {
        loadTabContent();
        updatePreview();
        updateDirtyDots();
      }
      break;
    }

    case 'save-ok':
      savedSnapshot = JSON.stringify(content);
      updateDirtyDots();
      showSavedMsg();
      break;

    case 'index-results':
      indexedComponents = msg.data || [];
      showScreen(VIEW.INDEX_RESULTS);
      break;

    case 'indexed-components':
      indexedComponents = msg.data || [];
      // Only navigate if the user is still in the editing/index flow
      // (don't forcefully pull them away from chip or drift)
      if (currentView === VIEW.AUTHORING || currentView === VIEW.INDEX_START || currentView === VIEW.INDEX_RESULTS) {
        if (indexedComponents.length > 0) {
          showScreen(VIEW.INDEX_RESULTS);
        } else {
          showScreen(VIEW.INDEX_START);
        }
      }
      break;

    case 'detach-count':
      updateChipCount(msg.detachCount || 0);
      break;

    case 'drift':
      updateChipCount(msg.detachCount || 0);
      // Guard: only show modal if on chip or drift (don't interrupt editor/index)
      if (currentView === VIEW.TINY_CHIP || currentView === VIEW.DRIFT_MODAL) {
        showDriftModal(msg.category, msg.content);
      }
      break;
  }
}

/* â”€â”€ Drag-to-resize (corner handle) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
/* Minimum sizes per resizable screen */
const MIN_W_AUTH = 400, MIN_H_AUTH = 300;

(function initResizeHandle() {
  const handle = document.getElementById('resize-handle');
  let dragging = false;
  let startX, startY, startW, startH;

  handle.addEventListener('pointerdown', (e) => {
    // Only allow on resizable screens
    if (!document.body.classList.contains('resizable')) return;
    dragging = true;
    startX = e.clientX;
    startY = e.clientY;
    startW = document.documentElement.clientWidth;
    startH = document.documentElement.clientHeight;
    handle.setPointerCapture(e.pointerId);
    e.preventDefault();
  });

  handle.addEventListener('pointermove', (e) => {
    if (!dragging) return;
    e.preventDefault();              // prevent text selection while dragging
    const dx = e.clientX - startX;
    const dy = e.clientY - startY;

    const newW = Math.max(MIN_W_AUTH, Math.round(startW + dx));
    const newH = Math.max(MIN_H_AUTH, Math.round(startH + dy));
    resize(newW, newH);
  });

  function stopDrag(e) {
    if (!dragging) return;
    dragging = false;
    handle.releasePointerCapture(e.pointerId);
  }
  handle.addEventListener('pointerup', stopDrag);
  handle.addEventListener('pointercancel', stopDrag);
})();

/* â”€â”€ Toast helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function showToast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 2000);
}
</script>
</body>
</html>
